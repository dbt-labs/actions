# **what?**
# This workflow installs the latest version of dbt adapter from PyPI.
# It then runs 'dbt --version' to verify the installation was successful.
# If it fails for the scheduled runs, it will post to our team alerts channel.

# **why?**
# This is a simple way to test all adapter installations at a single
# time. It allows us to test them on a schedule as well to check for
# any breaking dependency changes that might happen and alert us on it.

# **when?**
# This reusable workflow can be called or started manually
# by specifying the package name

name: dbt Installation - pip Integration Tests

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: "Package name to test (i.e. dbt-postgres)"
        required: true
        type: string
  workflow_call:
    inputs:
      package_name:
        required: true
        type: string
    secrets:
      SLACK_WEBHOOK_URL:
        description: Slack app webhook url
        required: true

permissions:
  contents: read # required for slack-post-notification workflow

jobs:
  pip-installation-test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10"]

    steps:
      - name: "Set up Python - ${{ matrix.python-version }}"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: "Update Python Packages"
        run: |
          python -m pip install --user --upgrade pip

      - name: "[DEBUG] Show Package Installer Python Version"
        run: |
          python -m pip --version

      - name: "Install Package - ${{ inputs.package_name }}"
        run: |
          python -m pip install pip ${{ inputs.package_name }}

      - name: "[DEBUG] Show Installed Packages"
        run: |
          python -m pip list

      - name: "[DEBUG] Show Package Info - ${{ inputs.package_name }}"
        run: |
          python -m pip show ${{ inputs.package_name }}

      - name: "Verify ${{ inputs.package_name }} Version"
        run: |
          dbt --version

      - name: "Dump Job Status"
        id: job-status
        run: |
          folder="pip-installation" 
          file="test-job-${{ strategy.job-index }}-python-version-v${{ matrix.python-version }}.json"
          mkdir -p $folder
          touch $folder/$file
          echo $JOB_CONTEXT >> $folder/$file
          echo "path=$folder/$file" >> $GITHUB_OUTPUT

        env:
          JOB_CONTEXT: ${{ toJson(job.status) }}

      - name: "Upload Job Status"
        uses: actions/upload-artifact@v3
        with:
          name: dbt-installation-logs
          path: ${{ steps.job-status.outputs.path }}
          retention-days: 1

  dump-context:
    name: Dump Jobs Context
    runs-on: ubuntu-latest
    needs: pip-installation-test

    steps:
      - name: Dump matrix context
        env:
          MATRIX_CONTEXT: ${{ toJson(matrix) }}
        run: echo "$MATRIX_CONTEXT"
      - name: Dump job context
        env:
          JOB_CONTEXT: ${{ toJson(job) }}
        run: echo "$JOB_CONTEXT"
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

  slack-notification:
    name: "Post Scheduled Run Failures"
    needs: pip-installation-test
    if: ${{ failure() && github.event_name == 'schedule' }}

    uses: dbt-labs/dbt-release/.github/workflows/slack-post-notification.yml@main
    with:
      status: "failure"
      notification_title: "pip nightly installation test failed for - ${{ inputs.package_name }}"

    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
