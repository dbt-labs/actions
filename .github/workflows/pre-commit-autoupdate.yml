name: "Run pre-commit autoupdate"

on:
  workflow_call:
    secrets:
      TOKEN:
        description: "Your token"
        required: true
      SLACK_WEBHOOK_URL:
        description: "The webhook for the Slack channel to post the notification"
        required: false

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  precommit-autoupdate:
    name: "pre-commit autoupdate"
    runs-on: ubuntu-latest
    steps:
      - name: "Check out repository"
        uses: actions/checkout@v4

      - name: "Create a new branch"
        id: branch
        run: |
          branch=pre-commit/$(date +'%Y-%m-%dT%H_%M_%S')
          git checkout -b $branch
          echo "name=$branch" >> $GITHUB_OUTPUT

      - name: "Add brew to the PATH"
        run: echo "/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin" >> $GITHUB_PATH

      - name: "Install pre-commit"
        run: brew install pre-commit

      - name: "Check for pre-commit hook updates"
        id: pre-commit
        run: |
          pre-commit autoupdate
          updates=$(git diff --raw)
          echo "updates=$updates" >> $GITHUB_OUTPUT

      - name: "Commit local changes"
        if: ${{ steps.pre-commit.outputs.updates }}
        run: |
          git config user.name "$USER"
          git config user.email "$EMAIL"
          git status
          git add .
          git commit -m "$MESSAGE"
        env:
          USER: "Github Build Bot"
          EMAIL: "buildbot@fishtownanalytics.com"
          MESSAGE: "[automated] update pre-commit hooks"

      - name: "Open pull request"
        if: ${{ steps.pre-commit.outputs.updates }}
        id: pull_request
        run: |
          git push --set-upstream origin $HEAD
          url=$(gh pr create --base $TARGET --head $HEAD --title "$TITLE" --body "$BODY")
          echo "url=$url" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
          TITLE: "[Automated] Update pre-commit hooks"
          BODY: "Pre-commit hooks have updates that require resolution."
          HEAD: ${{ steps.branch.outputs.name }}
          TARGET: "main"

      - name: "[Notification] Pull request opened"
        if: ${{ steps.pre-commit.outputs.updates }}
        run: |
          message="PR opened at ${{ steps.pull_request.outputs.url }}"
          echo "::notice title="Pull request opened": $title::$message"

      - name: "[Slack] Pull request opened"
        if: ${{ steps.pre-commit.outputs.updates && secrets.SLACK_WEBHOOK_URL }}
        uses: ravsamhq/notify-slack-action@v2
        with:
          status: "success"
          token: ${{ secrets.TOKEN }}
          notification_title: "[Automated] Update pre-commit hooks"
          notify_when: "success,failure"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
